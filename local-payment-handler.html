<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MonadPay æœ¬åœ°æ”¯ä»˜å¤„ç†å™¨</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .payment-card {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            background: #f8f9fa;
        }
        .amount {
            font-size: 2em;
            font-weight: bold;
            color: #28a745;
            text-align: center;
            margin: 20px 0;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin: 10px 0;
        }
        .button:hover {
            background: #0056b3;
        }
        .button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #cce7ff; color: #004085; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ’³ MonadPay æœ¬åœ°æ”¯ä»˜å¤„ç†å™¨</h1>
        
        <div id="ethersStatus" class="status info">
            ğŸ”„ æ­£åœ¨åŠ è½½ethers.jsåº“...
        </div>
        
        <div id="urlParams" class="payment-card">
            <h3>ğŸ“‹ URLå‚æ•°è§£æ</h3>
            <div id="paramsList"></div>
        </div>

        <div id="paymentCard" class="payment-card" style="display: none;">
            <h3>ğŸ’¸ æ”¯ä»˜è¯¦æƒ…</h3>
            <div class="amount" id="displayAmount">0 USDC</div>
            
            <div class="info-row">
                <span><strong>æ”¶æ¬¾åœ°å€:</strong></span>
                <span id="displayRecipient">-</span>
            </div>
            <div class="info-row">
                <span><strong>æ”¯ä»˜æ ‡ç­¾:</strong></span>
                <span id="displayLabel">-</span>
            </div>
            <div class="info-row">
                <span><strong>ä»£å¸:</strong></span>
                <span id="displayToken">-</span>
            </div>
            
            <button class="button" onclick="connectWallet()" id="connectBtn">
                ğŸ”— è¿æ¥MetaMaské’±åŒ…
            </button>
            
            <button class="button" onclick="executePayment()" id="payBtn" style="display: none;" disabled>
                ğŸ’³ ç¡®è®¤æ”¯ä»˜
            </button>
        </div>

        <div id="status"></div>

        <div class="payment-card">
            <h3>ğŸ”— æµ‹è¯•URLç¤ºä¾‹</h3>
            <p>ç‚¹å‡»ä¸‹é¢çš„é“¾æ¥æµ‹è¯•URLå‚æ•°è§£æï¼š</p>
            <a href="?to=0x0000000000000000000000000000000000000456&amount=10.5&token=USDC&label=è´­ä¹°å’–å•¡" 
               onclick="window.location.href=this.href; return false;">
                ğŸ“± æµ‹è¯•æ”¯ä»˜é“¾æ¥ (10.5 USDC)
            </a>
        </div>
    </div>

    <script>
        // åˆçº¦é…ç½®
        const PAYMENT_SYSTEM_ADDRESS = "0x973112eC6e02E307C1Aa045187601AECA34cd8a5";
        const MONAD_CHAIN_ID = 10143;

        let provider;
        let signer;
        let paymentContract;
        let paymentParams = {};

        // ç®€åŒ–çš„æ”¯ä»˜å‡½æ•°ï¼ˆä¸ä½¿ç”¨ethers.jsï¼‰
        async function simplePayment() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('è¯·å®‰è£…MetaMaské’±åŒ…');
                }

                // è¯·æ±‚è¿æ¥
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                const fromAddress = accounts[0];
                
                showStatus(`âœ… é’±åŒ…å·²è¿æ¥: ${fromAddress}`, 'success');
                
                // æ„å»ºäº¤æ˜“æ•°æ®
                const recipient = paymentParams.to;
                const amount = paymentParams.amount;
                
                // ç®€å•çš„åŸç”Ÿä»£å¸è½¬è´¦
                if (paymentParams.token.toLowerCase() === 'monad' || paymentParams.token.toLowerCase() === 'mon') {
                    const amountWei = '0x' + (parseFloat(amount) * Math.pow(10, 18)).toString(16);
                    
                    const txParams = {
                        from: fromAddress,
                        to: recipient,
                        value: amountWei,
                        gas: '0x5208', // 21000
                    };
                    
                    const txHash = await window.ethereum.request({
                        method: 'eth_sendTransaction',
                        params: [txParams],
                    });
                    
                    showStatus(`âœ… äº¤æ˜“å·²å‘é€!<br>äº¤æ˜“å“ˆå¸Œ: ${txHash}`, 'success');
                } else {
                    throw new Error('å½“å‰ç®€åŒ–ç‰ˆæœ¬åªæ”¯æŒMONADåŸç”Ÿä»£å¸æ”¯ä»˜');
                }
                
            } catch (error) {
                showStatus(`âŒ æ”¯ä»˜å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„å¤„ç†
        window.onload = function() {
            // æ˜¾ç¤ºethersçŠ¶æ€
            document.getElementById('ethersStatus').innerHTML = 
                '<div class="warning">âš ï¸ ä½¿ç”¨ç®€åŒ–ç‰ˆæœ¬ï¼ˆä¸ä¾èµ–ethers.jsï¼‰<br>å½“å‰åªæ”¯æŒMONADåŸç”Ÿä»£å¸æ”¯ä»˜</div>';
            
            parseURLParams();
        };

        // è§£æURLå‚æ•°
        function parseURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const params = {};
            
            const supportedParams = ['to', 'amount', 'token', 'label'];
            
            let paramsList = '<div class="info-row"><strong>æ£€æµ‹åˆ°çš„URLå‚æ•°:</strong></div>';
            
            supportedParams.forEach(param => {
                const value = urlParams.get(param);
                if (value) {
                    params[param] = decodeURIComponent(value);
                    paramsList += `<div class="info-row"><span>${param}:</span><span>${params[param]}</span></div>`;
                }
            });
            
            if (Object.keys(params).length === 0) {
                paramsList = '<div class="warning">æœªæ£€æµ‹åˆ°æ”¯ä»˜å‚æ•°ã€‚ä½¿ç”¨æµ‹è¯•é“¾æ¥æˆ–åœ¨URLä¸­æ·»åŠ å‚æ•°ã€‚</div>';
                document.getElementById('paramsList').innerHTML = paramsList;
                return;
            }
            
            document.getElementById('paramsList').innerHTML = paramsList;
            
            if (params.to && params.amount && params.token) {
                paymentParams = params;
                displayPaymentCard();
            } else {
                showStatus('ç¼ºå°‘å¿…éœ€å‚æ•°ã€‚éœ€è¦: to, amount, token', 'error');
            }
        }

        // æ˜¾ç¤ºæ”¯ä»˜å¡ç‰‡
        function displayPaymentCard() {
            document.getElementById('displayAmount').textContent = 
                `${paymentParams.amount} ${paymentParams.token}`;
            document.getElementById('displayRecipient').textContent = paymentParams.to;
            document.getElementById('displayLabel').textContent = paymentParams.label || 'æ— æ ‡ç­¾';
            document.getElementById('displayToken').textContent = paymentParams.token;
            
            document.getElementById('paymentCard').style.display = 'block';
        }

        // è¿æ¥é’±åŒ…ï¼ˆç®€åŒ–ç‰ˆï¼‰
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('è¯·å®‰è£…MetaMaské’±åŒ…');
                }

                // è¯·æ±‚è¿æ¥
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // æ£€æŸ¥ç½‘ç»œ
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                const targetChainId = '0x279F';
                
                if (chainId !== targetChainId) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: targetChainId }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: targetChainId,
                                    chainName: 'Monad Testnet',
                                    nativeCurrency: {
                                        name: 'MON',
                                        symbol: 'MON',
                                        decimals: 18
                                    },
                                    rpcUrls: ['https://testnet-rpc.monad.xyz'],
                                    blockExplorerUrls: ['https://testnet-explorer.monad.xyz']
                                }]
                            });
                        }
                    }
                }

                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                showStatus(`âœ… é’±åŒ…å·²è¿æ¥: ${accounts[0]}`, 'success');
                
                document.getElementById('connectBtn').style.display = 'none';
                document.getElementById('payBtn').style.display = 'block';
                document.getElementById('payBtn').disabled = false;
                
            } catch (error) {
                showStatus(`âŒ é’±åŒ…è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ‰§è¡Œæ”¯ä»˜ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function executePayment() {
            simplePayment();
        }

        // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
        function showStatus(message, type) {
            document.getElementById('status').innerHTML = 
                `<div class="status ${type}">${message}</div>`;
        }
    </script>
</body>
</html> 