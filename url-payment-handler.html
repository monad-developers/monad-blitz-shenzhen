<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MonadPay URL</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        // å¤‡ç”¨åŠ è½½æ–¹æ¡ˆ
        if (typeof ethers === 'undefined') {
            console.log('ä¸»CDNåŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨CDN...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js';
            script.onload = function() {
                console.log('âœ… å¤‡ç”¨CDNåŠ è½½æˆåŠŸ');
            };
            script.onerror = function() {
                console.error('âŒ æ‰€æœ‰CDNéƒ½åŠ è½½å¤±è´¥');
                document.body.innerHTML = '<div style="text-align:center;padding:50px;"><h2>âŒ ç½‘ç»œé”™è¯¯</h2><p>æ— æ³•åŠ è½½ethers.jsåº“ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</p></div>';
            };
            document.head.appendChild(script);
        }
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .payment-card {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            background: #f8f9fa;
        }
        .amount {
            font-size: 2em;
            font-weight: bold;
            color: #28a745;
            text-align: center;
            margin: 20px 0;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin: 10px 0;
        }
        .button:hover {
            background: #0056b3;
        }
        .button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #cce7ff; color: #004085; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ’³ MonadPay </h1>
        
        <div id="urlParams" class="payment-card">
            <h3>ğŸ“‹ URLå‚æ•°è§£æ</h3>
            <div id="paramsList"></div>
        </div>

        <div id="paymentCard" class="payment-card" style="display: none;">
            <h3>ğŸ’¸ æ”¯ä»˜è¯¦æƒ…</h3>
            <div class="amount" id="displayAmount">0 USDC</div>
            
            <div class="info-row">
                <span><strong>æ”¶æ¬¾åœ°å€:</strong></span>
                <span id="displayRecipient">-</span>
            </div>
            <div class="info-row">
                <span><strong>æ”¯ä»˜æ ‡ç­¾:</strong></span>
                <span id="displayLabel">-</span>
            </div>
            <div class="info-row">
                <span><strong>ä»£å¸:</strong></span>
                <span id="displayToken">-</span>
            </div>
            
            <button class="button" onclick="connectWallet()" id="connectBtn">
                ğŸ”— è¿æ¥MetaMaské’±åŒ…
            </button>
            
            <button class="button" onclick="executePayment()" id="payBtn" style="display: none;" disabled>
                ğŸ’³ ç¡®è®¤æ”¯ä»˜
            </button>
        </div>

        <div id="status"></div>

        <div class="payment-card">
            <h3>ğŸ”— æµ‹è¯•URLç¤ºä¾‹</h3>
            <p>ç‚¹å‡»ä¸‹é¢çš„é“¾æ¥æµ‹è¯•URLå‚æ•°è§£æï¼š</p>
            <a href="?to=0x0000000000000000000000000000000000000456&amount=0.01&token=MONAD&label=è´­ä¹°å’–å•¡" 
               onclick="window.location.href=this.href; return false;">
                ğŸ“± æµ‹è¯•æ”¯ä»˜é“¾æ¥ (0.01 MONAD) - æ¨è
            </a>
            <br><br>
            <a href="?to=0x0000000000000000000000000000000000000456&amount=1.0&token=USDC&label=è´­ä¹°å•†å“" 
               onclick="window.location.href=this.href; return false;">
                ğŸ“± æµ‹è¯•USDCæ”¯ä»˜ (1.0 USDC) - å®éªŒæ€§
            </a>
        </div>
    </div>

    <script>
        // åˆçº¦é…ç½®
        const PAYMENT_SYSTEM_ADDRESS = "0x973112eC6e02E307C1Aa045187601AECA34cd8a5";
        const MONAD_CHAIN_ID = 10143;
        
        const PAYMENT_ABI = [
            "function singlePayment(address recipient, address token, uint256 amount, string memory label) external payable",
            "function getTokenBySymbol(string memory symbol) external view returns (address)",
            "function platformFee() external view returns (uint256)",
            "function feeRecipient() external view returns (address)",
            "function owner() external view returns (address)",
            "function paused() external view returns (bool)"
        ];

        let provider;
        let signer;
        let paymentContract;
        let paymentParams = {};

        // é¡µé¢åŠ è½½æ—¶è§£æURLå‚æ•°
        window.onload = function() {
            // æ£€æŸ¥ethersæ˜¯å¦åŠ è½½æˆåŠŸ
            if (typeof ethers === 'undefined') {
                showStatus('âŒ ethers.jsåº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                return;
            }
            console.log('âœ… ethers.jsåŠ è½½æˆåŠŸï¼Œç‰ˆæœ¬:', ethers.version);
            parseURLParams();
        };

        // è§£æURLå‚æ•°
        function parseURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const params = {};
            
            // æ”¯æŒçš„å‚æ•°
            const supportedParams = ['to', 'amount', 'token', 'label'];
            
            let paramsList = '<div class="info-row"><strong>æ£€æµ‹åˆ°çš„URLå‚æ•°:</strong></div>';
            
            supportedParams.forEach(param => {
                const value = urlParams.get(param);
                if (value) {
                    params[param] = value;
                    paramsList += `<div class="info-row"><span>${param}:</span><span>${value}</span></div>`;
                }
            });
            
            if (Object.keys(params).length === 0) {
                paramsList = '<div class="warning">æœªæ£€æµ‹åˆ°æ”¯ä»˜å‚æ•°ã€‚ä½¿ç”¨æµ‹è¯•é“¾æ¥æˆ–åœ¨URLä¸­æ·»åŠ å‚æ•°ã€‚</div>';
                document.getElementById('paramsList').innerHTML = paramsList;
                return;
            }
            
            document.getElementById('paramsList').innerHTML = paramsList;
            
            // éªŒè¯å¿…éœ€å‚æ•°
            if (params.to && params.amount && params.token) {
                paymentParams = params;
                displayPaymentCard();
            } else {
                showStatus('ç¼ºå°‘å¿…éœ€å‚æ•°ã€‚éœ€è¦: to, amount, token', 'error');
            }
        }

        // æ˜¾ç¤ºæ”¯ä»˜å¡ç‰‡
        function displayPaymentCard() {
            document.getElementById('displayAmount').textContent = 
                `${paymentParams.amount} ${paymentParams.token}`;
            document.getElementById('displayRecipient').textContent = paymentParams.to;
            document.getElementById('displayLabel').textContent = paymentParams.label || 'æ— æ ‡ç­¾';
            document.getElementById('displayToken').textContent = paymentParams.token;
            
            document.getElementById('paymentCard').style.display = 'block';
        }

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('è¯·å®‰è£…MetaMaské’±åŒ…');
                }

                // è¯·æ±‚è¿æ¥
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // æ£€æŸ¥/åˆ‡æ¢ç½‘ç»œ
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                const targetChainId = '0x279F'; // 10143çš„åå…­è¿›åˆ¶
                
                if (chainId !== targetChainId) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: targetChainId }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: targetChainId,
                                    chainName: 'Monad Testnet',
                                    nativeCurrency: {
                                        name: 'MON',
                                        symbol: 'MON',
                                        decimals: 18
                                    },
                                    rpcUrls: ['https://testnet-rpc.monad.xyz'],
                                    blockExplorerUrls: ['https://testnet-explorer.monad.xyz']
                                }]
                            });
                        }
                    }
                }

                // åˆ›å»ºproviderå’Œsigner
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                paymentContract = new ethers.Contract(PAYMENT_SYSTEM_ADDRESS, PAYMENT_ABI, signer);
                
                const address = await signer.getAddress();
                
                // æµ‹è¯•åˆçº¦è¿æ¥
                try {
                    const platformFee = await paymentContract.platformFee();
                    showStatus(`âœ… é’±åŒ…å·²è¿æ¥: ${address}<br>ğŸ”— åˆçº¦è¿æ¥æˆåŠŸï¼Œå¹³å°è´¹ç‡: ${platformFee}/10000`, 'success');
                } catch (contractError) {
                    showStatus(`âš ï¸ é’±åŒ…å·²è¿æ¥: ${address}<br>âŒ åˆçº¦è¿æ¥å¤±è´¥: ${contractError.message}<br>ğŸ’¡ å¯èƒ½éœ€è¦åˆ‡æ¢åˆ°æ­£ç¡®çš„ç½‘ç»œæˆ–åˆçº¦åœ°å€æœ‰è¯¯`, 'warning');
                }
                
                // æ˜¾ç¤ºæ”¯ä»˜æŒ‰é’®
                document.getElementById('connectBtn').style.display = 'none';
                document.getElementById('payBtn').style.display = 'block';
                document.getElementById('payBtn').disabled = false;
                
            } catch (error) {
                showStatus(`âŒ é’±åŒ…è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ‰§è¡Œæ”¯ä»˜
        async function executePayment() {
            try {
                showStatus('ğŸ“¤ æ­£åœ¨å‡†å¤‡äº¤æ˜“...', 'info');
                
                const recipient = paymentParams.to;
                const amount = paymentParams.amount;
                const token = paymentParams.token;
                const label = paymentParams.label || '';

                let tokenAddress;
                let amountWei;
                let txValue = 0;

                                 // å¤„ç†ä¸åŒçš„ä»£å¸ç±»å‹
                 if (token.toLowerCase() === 'monad' || token.toLowerCase() === 'mon') {
                     // åŸç”Ÿä»£å¸
                     tokenAddress = ethers.constants.AddressZero;
                     amountWei = ethers.utils.parseEther(amount);
                     txValue = amountWei;
                 } else if (token.toLowerCase() === 'usdc') {
                     // USDCä»£å¸ - ä½¿ç”¨å›ºå®šåœ°å€ï¼ˆæµ‹è¯•ç½‘ï¼‰
                     tokenAddress = "0x0000000000000000000000000000000000000001"; // åœ¨éƒ¨ç½²æ—¶æ³¨å†Œçš„æµ‹è¯•åœ°å€
                     amountWei = ethers.utils.parseEther(amount);
                     txValue = 0;
                 } else if (token.toLowerCase() === 'usdt') {
                     // USDTä»£å¸ - ä½¿ç”¨å›ºå®šåœ°å€ï¼ˆæµ‹è¯•ç½‘ï¼‰
                     tokenAddress = "0x0000000000000000000000000000000000000002"; // åœ¨éƒ¨ç½²æ—¶æ³¨å†Œçš„æµ‹è¯•åœ°å€
                     amountWei = ethers.utils.parseEther(amount);
                     txValue = 0;
                 } else {
                     throw new Error(`å½“å‰æ¼”ç¤ºç‰ˆæœ¬ä¸æ”¯æŒä»£å¸: ${token}ã€‚æ”¯æŒçš„ä»£å¸: MONAD, USDC, USDT`);
                 }

                showStatus('ğŸ’¸ æ­£åœ¨å‘é€äº¤æ˜“...', 'info');

                // å‘é€äº¤æ˜“
                const tx = await paymentContract.singlePayment(
                    recipient,
                    tokenAddress,
                    amountWei,
                    label,
                    { value: txValue }
                );

                showStatus(`â³ ç­‰å¾…äº¤æ˜“ç¡®è®¤...<br>äº¤æ˜“å“ˆå¸Œ: ${tx.hash}`, 'info');

                // ç­‰å¾…ç¡®è®¤
                const receipt = await tx.wait();

                showStatus(`âœ… æ”¯ä»˜æˆåŠŸ!<br>
                    äº¤æ˜“å“ˆå¸Œ: ${tx.hash}<br>
                    åŒºå—å·: ${receipt.blockNumber}<br>
                    <a href="https://testnet-explorer.monad.xyz/tx/${tx.hash}" target="_blank">åœ¨åŒºå—é“¾æµè§ˆå™¨ä¸­æŸ¥çœ‹</a>`, 'success');

                // ç¦ç”¨æ”¯ä»˜æŒ‰é’®
                document.getElementById('payBtn').disabled = true;
                document.getElementById('payBtn').textContent = 'âœ… æ”¯ä»˜å®Œæˆ';

            } catch (error) {
                showStatus(`âŒ æ”¯ä»˜å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
        function showStatus(message, type) {
            document.getElementById('status').innerHTML = 
                `<div class="status ${type}">${message}</div>`;
        }
    </script>
</body>
</html> 